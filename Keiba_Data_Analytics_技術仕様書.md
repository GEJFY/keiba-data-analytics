# Keiba Data Analytics — 競馬定量投資プラットフォーム 技術仕様書

> **ドキュメント分類**: 機密
> **作成日**: 2026年2月11日
> **実装環境**: Claude Code + Python 3.11
> **リポジトリ**: `keiba-data-analytics`

---

## 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [設計原則](#2-設計原則)
3. [システムアーキテクチャ](#3-システムアーキテクチャ)
4. [技術スタック](#4-技術スタック)
5. [データモデル](#5-データモデル)
6. [アノマリー発見エンジン](#6-アノマリー発見エンジン)
7. [ファクタールール管理](#7-ファクタールール管理)
8. [スコアリングエンジン](#8-スコアリングエンジン)
9. [バックテストエンジン](#9-バックテストエンジン)
10. [自動投票エンジン](#10-自動投票エンジン)
11. [ダッシュボード仕様](#11-ダッシュボード仕様)
12. [LLM/AIエージェント活用機能](#12-llmaiエージェント活用機能)
13. [JVLinkToSQLite連携設計](#13-jvlinktosqlite連携設計)
14. [戦略エンジンインターフェース](#14-戦略エンジンインターフェース)
15. [ガバナンスと管理](#15-ガバナンスと管理)
16. [非機能要件](#16-非機能要件)
17. [開発ロードマップ](#17-開発ロードマップ)
18. [リポジトリ構成](#18-リポジトリ構成)
19. [Claude Code実装プロンプト](#19-claude-code実装プロンプト)
20. [免責事項](#20-免責事項)

---

## 1. プロジェクト概要

### 1.1 目的

本プラットフォームは、JRA（日本中央競馬会）の競馬データを定量的に分析し、馬券裁判で知られる卍氏の投資手法を参考にした **「バリュー投資戦略」** に基づく競馬投資の意思決定を支援・自動化するシステムである。

具体的には以下の機能を提供する:

1. **JRA-VAN データラボ連携** — JVLinkToSQLiteによるデータの自動取込
2. **アノマリー発見** — 競馬市場の非効率性を統計的に検出・検証
3. **ファクタールール管理** — ルールの作成・編集・有効性検証・ライフサイクル管理
4. **スコアリングエンジン** — 複合ファクターによる卍指数方式のスコアリング
5. **期待値ベースのベット生成** — オッズ比較による割安馬券の抽出
6. **バックテスト** — 過去データによるルール有効性の厳密な検証
7. **自動投票** — JRA IPAT連携（Selenium / ipatgo）
8. **ダッシュボード** — グラフ・チャートを駆使した美しく使いやすい運用画面
9. **AIエージェント** — Azure AI Foundry / GCP Vertex AI経由のLLMによるアノマリー探索・レポート自動生成

### 1.2 投資哲学 — 卍氏の馬券裁判手法

本システムの投資戦略は、2005年〜2009年の5年間で累計約35億円の馬券を購入し約1億5000万円の利益を上げた **卍（まんじ）氏** の手法を基礎とする。卍氏は2015年に最高裁で外れ馬券の経費算入が認められた「馬券裁判」の当事者であり、そのアプローチは以下の原則に基づく。

| 原則 | 内容 |
|------|------|
| **バリュー投資** | 「強い馬を買う」のではなく「過小評価されている馬を買う」。的中率より回収率を重視 |
| **ファクタースコアリング** | 約45のファクター（計算式）を用いて各馬に得点を付与。回収率が高い条件に加点、低い条件に減点 |
| **オッズとの比較** | 得点が高いにもかかわらず人気になっていない馬（＝期待値が高い馬）を機械的に抽出 |
| **大量・機械的売買** | 全レースを対象に条件に合致する馬券を自動購入。大数の法則によりリスクをヘッジ |
| **資金管理** | 残余資金に基づく配分ルール。最大損失（92%ドローダウン）を経験しても破産しない設計 |
| **継続的改善** | ファクターの有効性を定期的に検証し、時代の変化に応じて計算式を修正 |

#### 1.2.1 卍手法の核心 — なぜ「予想」ではなく「投資」か

卍氏の手法は従来の「競馬予想」とは根本的に異なる。ポイントは以下の3点:

1. **市場の非効率性を突く**: 馬券市場は完全に効率的ではなく、一般購入者の認知バイアス（直近の結果に引きずられる等）により、常に一定の「歪み」が存在する
2. **期待値＞1 を機械的に抽出**: 個々のレースの勝敗ではなく、統計的に期待値がプラスとなる馬券を大量に購入することで、大数の法則により長期的な利益を確保する
3. **感情を排除した機械的執行**: 人間の直感・感情を排除し、数式に基づくルールを厳格に適用する。「今回は見送る」「この馬は好きだから買う」といった恣意的判断を一切排除する

#### 1.2.2 卍氏の実績から読み取れるリスク特性

卍氏の5年間の運用データから推定されるリスク特性:

| 指標 | 推定値 | 意味 |
|------|--------|------|
| 年間購入額 | 約7億円 | 年間約2,500レースに投票 |
| 年間利益 | 約3,000万円 | 回収率約104% |
| 最大ドローダウン | 約92% | 一時的に資金の92%を失う局面がある |
| 回収率 | 約104〜105% | 控除率（約25%）を加味すると極めて高い |
| 回復期間 | 数ヶ月 | 大きなドローダウンからの回復に数ヶ月要する |

> [!WARNING]
> 92%のドローダウンは、100万円の運用資金が一時8万円まで減少することを意味する。この心理的圧力に耐えうる資金管理と精神的準備が不可欠である。

### 1.3 卍指数の構成要素（判明分）

卍指数は **10カテゴリー・全45ファクター** で構成される。公開されているファクターの例を以下に示す:

| カテゴリー | ファクター例 | 加減点ロジック |
|------------|-------------|----------------|
| 過去レース評価 | 前走着順 | 前走上位着順の馬は過大評価されやすいため減点傾向 |
| 対戦型 | 同一レース出走歴 | 着順が良かった方に-1点、悪かった方に+1点 |
| レース中の不利 | 出遅れ・不利経験 | 近走で出遅れや不利を受けた馬に+1点 |
| タイム評価 | 勝ち馬とのタイム差 | 0.5秒以内+1点、0.2秒以内さらに+1点 |
| 馬場適性 | 芝/ダート転向 | 芝レースで近走ダート好走馬は-1点、凡走馬は+1点 |
| 枠順 | 偶数枠/奇数枠 | データ上回収率に差がある枠に応じて加減点 |
| 馬種別 | 性別・季節 | 牝馬と季節との関係でファクターを設定 |
| 血統 | 種牡馬評価 | 近年の回収率傾向を定期チェックし重みづけ |
| 騎手 | 乗替り効果 | リーディング下位→トップ10乗替り時に加点 |
| 馬体重 | 出走馬内の相対順位 | 馬体重は絶対値でなく出走馬内の順位で評価 |

#### 1.3.1 ファクター設計の基本方針

卍指数のファクターは以下の設計思想に基づく:

1. **逆張り志向**: 一般購入者が「マイナス」と評価する要素にこそ「プラス」の期待値が隠れている
2. **相対評価**: 絶対的な能力値ではなく、市場の評価（オッズ）との乖離を重視する
3. **統計的根拠**: 全てのファクターは過去データの統計的検証に裏付けられていなければならない
4. **有効期限の管理**: 市場が学習しファクターの有効性が減衰する可能性を常に監視する

---

## 2. 設計原則

| 原則 | 説明 |
|------|------|
| **再現性（Reproducibility）** | 保存データ・戦略バージョン・パラメータから全ての意思決定を再現可能 |
| **監査性（Auditability）** | 生データ・モデル出力・投票決定を完全にログ記録 |
| **モジュール性（Modularity）** | データプロバイダー・戦略・ファクターをプラグイン方式で追加可能 |
| **シンプルさ（Simplicity）** | ローカルファースト、SQLiteベース、最小限の運用負荷 |
| **拡張性（Extensibility）** | 将来のAPI化、クラウド化、マルチユーザー展開に対応可能 |
| **自動化（Automation）** | データ取得→分析→投票→結果回収の全工程を自動化 |
| **フェイルセーフ（Fail-Safe）** | 障害発生時は「投票しない」方向に安全に倒す。不確実な状態での投票実行を禁止 |
| **データ品質保証（Data Quality）** | 入力データの整合性チェックを全パイプラインで実施。欠損・異常値の自動検出と報告 |

---

## 3. システムアーキテクチャ

### 3.1 全体構成図

システムは以下の **7層** で構成される:

| 層 | コンポーネント | 技術 |
|----|--------------|------|
| ① データ取得層 | JVLinkToSQLite連携、自動スケジューラ | C#(.NET) / PowerShell / Task Scheduler |
| ② データストア層 | JRA-VAN SQLite DB + 分析用拡張テーブル | SQLite |
| ③ アノマリー発見層 | ファクター候補生成、統計検証エンジン | Python / Pandas / SciPy / LLM Gateway |
| ④ スコアリング層 | ファクター統合、期待値計算、ベット生成 | Python / NumPy / scikit-learn |
| ⑤ バックテスト層 | 過去データによる戦略検証 | Python / Pandas |
| ⑥ 投票実行層 | JRA IPAT自動投票、結果回収 | Python / Selenium / ipatgo |
| ⑦ ダッシュボード層 | 運用成績可視化、ルール管理、レポート生成 | Streamlit / Plotly / LLM Gateway |

```
┌──────────────────────────────────────────────────────────────────┐
│  ⑦ ダッシュボード層                                             │
│     Streamlit + Plotly + カスタムCSS                             │
│     ┌────────┬────────┬────────┬────────┬────────┬────────┐      │
│     │データ  │ファクタ│ 戦略   │ P&L    │バック  │ AI     │      │
│     │管理    │ー管理  │ 実行   │        │テスト  │アシスト│      │
│     └────────┴────────┴────────┴────────┴────────┴────────┘      │
├──────────────────────────────────────────────────────────────────┤
│  ⑥ 投票実行層 (Selenium / ipatgo → JRA IPAT)                    │
├──────────────────────────────────────────────────────────────────┤
│  ⑤ バックテスト層 (Walk-Forward / Monte Carlo)                   │
├──────────────────────────────────────────────────────────────────┤
│  ④ スコアリング層 (卍指数 + EV計算 + 確率校正)                   │
├──────────────────────────────────────────────────────────────────┤
│  ③ アノマリー発見層 (統計検証 + LLM Gateway)                     │
├──────────────────────────────────────────────────────────────────┤
│  ② データストア層 (SQLite — JVLink DB + 拡張テーブル)             │
├──────────────────────────────────────────────────────────────────┤
│  ① データ取得層 (JVLinkToSQLite + Task Scheduler)                │
└──────────────────────────────────────────────────────────────────┘
              ↕                              ↕
    ┌─────────────────┐       ┌──────────────────────────────┐
    │  JRA-VAN DataLab │       │     LLM Gateway (抽象化層)    │
    │  (JV-Link API)   │       │  ┌────────┐  ┌───────────┐  │
    └─────────────────┘       │  │ Azure   │  │ GCP       │  │
                               │  │ AI      │  │ Vertex AI │  │
                               │  │ Foundry │  │           │  │
                               │  └────────┘  └───────────┘  │
                               └──────────────────────────────┘
```

### 3.2 処理フロー

#### 週次運用フロー

| 曜日・タイミング | 処理内容 |
|------------------|----------|
| **水曜** | 出走表データ配信 → JVLinkToSQLiteが自動取込（Task Scheduler） |
| **木〜金曜** | 前日オッズ配信 → オッズスナップショット取得 |
| **土日当日朝** | スコアリングエンジン実行 → ベットリスト生成 |
| **各レース発走10分前** | 直前オッズ取得 → 最終フィルタ → IPAT自動投票 |
| **レース確定後** | 結果データ自動取込 → 収支計算 → ダッシュボード更新 |
| **月曜** | 週次レポート自動生成（LLMによるサマリー含む） |

#### 年次サイクル

| タイミング | 処理内容 |
|-----------|----------|
| **年末〜年初（年1回）** | LLM Gateway経由のDeep Researchによるアノマリー候補の網羅的調査。学術論文・海外事例・市場変化の調査 |
| **四半期末（年4回）** | ファクター有効性の総合レビュー。劣化ファクターの無効化・重み調整 |
| **月末（毎月）** | 月次パフォーマンスレポート生成。確率校正精度の検証 |

#### 障害時のリカバリーフロー

| 障害パターン | 対応 |
|-------------|------|
| JVLinkToSQLite取込失敗 | リトライ3回 → 失敗時はSlack/メール通知 → 該当レースの投票を自動スキップ |
| オッズ取得失敗 | 前日オッズで代替 → EV閾値を引き上げ（保守的に運用） |
| IPAT投票エラー | 即座に自動停止 → 手動確認を要求 |
| DB破損 | WALモードによる自動復旧 → 失敗時はバックアップから復元 |

---

## 4. 技術スタック

| レイヤー | 技術 | 備考 |
|----------|------|------|
| 言語 | Python 3.11+ | 分析・自動化の主軸 |
| データ取得 | JVLinkToSQLite (C#/.NET) | JRA-VAN DataLabのデータをSQLite化するOSSツール |
| データベース | SQLite | JVLinkToSQLiteが生成するDBをそのまま利用。WALモード |
| データ処理 | Pandas / NumPy / SciPy | 統計分析・特徴量エンジニアリング |
| 機械学習 | scikit-learn / LightGBM / XGBoost | アノマリー検出・確率推定モデル |
| UI/ダッシュボード | Streamlit + Plotly + カスタムCSS | モダンでプロフェッショナルなWeb UI |
| UIコンポーネント | streamlit-aggrid / extra-streamlit-components | データテーブル・拡張ウィジェット |
| 自動投票 | Selenium / ipatgo | JRA IPAT連携による自動馬券購入 |
| LLM基盤 | **Azure AI Foundry** + **GCP Vertex AI** | マルチプロバイダー対応のLLM Gateway経由で統一アクセス |
| LLMモデル | Claude Opus 4.6 / GPT-5.2 / Gemini 3.0 Pro Preview / Gemini 3.0 Flash Preview / その他 | 用途に応じてモデルを使い分け（詳細は[12章](#12-llmaiエージェント活用機能)） |
| バリデーション | Pydantic | 設定ファイル・データモデルの型安全性確保 |
| テスト | pytest | ファクター・戦略の単体/結合テスト |
| ログ | loguru | 構造化ログ。全パイプラインの追跡可能性確保 |
| スケジューリング | Windows Task Scheduler | 定期データ取得・分析実行 |
| パッケージ管理 | uv / pip | 高速依存関係管理 |
| バージョン管理 | Git | 戦略コード・設定のバージョニング |

---

## 5. データモデル

### 5.1 JVLinkToSQLiteのテーブル構造

JVLinkToSQLiteは、JRA-VAN DataLabのデータをSQLiteに変換し、`NL_`プレフィックスのテーブルを生成する。

#### 5.1.1 主要テーブル一覧

| テーブル名 | 内容 | 主要カラム |
|-----------|------|-----------|
| `NL_RA` | レース情報（開催・コース・レース名等） | Year, MonthDay, JyoCD, Kaiji, Nichiji, RaceNum, GradeCD, Kyori, TrackCD |
| `NL_SE` | 馬毎レース情報（出走馬・成績） | Year, MonthDay, JyoCD, ..., Bamei, Umaban, KakuteiJyuni, Ninki, Time |
| `NL_HR` | 払戻情報 | Year, MonthDay, JyoCD, ..., PayTansyoUmaban, PayTansyoPay |
| `NL_UM` | 競走馬マスタ | KettoNum, Bamei, Ketto3InfoBamei1（父馬名） |
| `NL_KS` | 騎手マスタ | KisyuCode, KisyuName |
| `NL_CH` | 調教師マスタ | ChokyosiCode, ChokyosiName |
| `NL_BN` | 繁殖馬マスタ | 繁殖登録番号, 馬名 |
| `NL_SK` | 産駒マスタ | 血統登録番号, 繁殖登録番号 |
| `NL_RC` | レコードマスタ | 競馬場コード, トラック, 距離等 |
| `NL_HC` | 馬体重データ | Year, MonthDay, ..., Zogen（増減） |
| `NL_WE` | 天候馬場状態 | Year, MonthDay, JyoCD, ... |
| `NL_JC` | 騎手変更 | Year, MonthDay, ..., 変更前後騎手 |
| `NL_CC` | コース変更 | Year, MonthDay, ... |
| `NL_AV` | 出走別着度数 | 出走回数, 1着回数, 2着回数等 |
| `NL_SC` | 坂路/ウッドチップ調教 | 調教日, タイム等 |
| `NL_O[1-6]` | オッズ（単勝〜三連単） | Year, MonthDay, ..., Odds |
| `NL_DM` | データマイニング予想 | タイム型/対戦型予想データ |
| `NL_WF` | WIN5データ | 重勝式データ |
| `NL_JG` | 競走馬除外情報 | 除外理由等 |

#### 5.1.2 テーブルJOIN条件

`NL_SE`と`NL_RA`のJOINは **6カラムの複合キー** で行う:

```sql
NL_SE.Year     = NL_RA.Year
AND NL_SE.MonthDay = NL_RA.MonthDay
AND NL_SE.JyoCD    = NL_RA.JyoCD
AND NL_SE.Kaiji    = NL_RA.Kaiji
AND NL_SE.Nichiji  = NL_RA.Nichiji
AND NL_SE.RaceNum  = NL_RA.RaceNum
```

上記の6カラム複合キーは本仕様書内で **`race_key`** と呼称する。`race_key`は以下の形式で文字列化する:

```
race_key = f"{Year}{MonthDay}{JyoCD}{Kaiji}{Nichiji}{RaceNum}"
```

全ての拡張テーブルはこの`race_key`をレース識別に使用する。

### 5.2 拡張テーブル（本システム固有）

JVLinkToSQLiteが生成するDBに加え、本システム独自のテーブルを同一DB（または別DB）に追加する。

#### 5.2.1 `factor_rules` — ファクタールール定義

| カラム | 型 | 説明 |
|--------|-----|------|
| `rule_id` (PK) | INTEGER | 自動採番 |
| `rule_name` | TEXT | ルール名（例: 前走僅差2着加点） |
| `category` | TEXT | カテゴリー（過去レース評価/枠順/血統等） |
| `description` | TEXT | ルールの詳細説明 |
| `sql_expression` | TEXT | SQLまたはPython式でのルール定義 |
| `weight` | REAL | 加減点の重み |
| `validation_score` | REAL | バックテストによる有効性スコア |
| `is_active` | INTEGER | 0/1 有効フラグ |
| `created_at` | TEXT | 作成日時 |
| `updated_at` | TEXT | 更新日時 |
| `source` | TEXT | ルールの出典（論文/経験則/ML発見/AI生成等） |
| `effective_from` | TEXT | ファクターの有効期間（開始日）。市場環境変化による無効化を管理 |
| `effective_to` | TEXT | ファクターの有効期間（終了日）。NULLの場合は現在有効 |
| `decay_rate` | REAL | ファクターの有効性減衰率。定期バックテストで更新 |
| `min_sample_size` | INTEGER | このルールの適用に必要な最小サンプル数 |
| `review_status` | TEXT | DRAFT / TESTING / APPROVED / DEPRECATED |
| `reviewed_at` | TEXT | 最終レビュー日時 |

#### 5.2.2 `factor_review_log` — ファクターレビュー履歴

| カラム | 型 | 説明 |
|--------|-----|------|
| `log_id` (PK) | INTEGER | 自動採番 |
| `rule_id` (FK) | INTEGER | 対象ファクタールールID |
| `action` | TEXT | CREATED / UPDATED / ACTIVATED / DEACTIVATED / DEPRECATED |
| `old_weight` | REAL | 変更前の重み（重み変更時） |
| `new_weight` | REAL | 変更後の重み |
| `reason` | TEXT | 変更理由 |
| `backtest_roi` | REAL | 変更時点でのバックテストROI |
| `changed_at` | TEXT | 変更日時 |
| `changed_by` | TEXT | 変更者（user / ai_agent / auto_review） |

#### 5.2.3 `horse_scores` — 馬スコア計算結果

| カラム | 型 | 説明 |
|--------|-----|------|
| `score_id` (PK) | INTEGER | 自動採番 |
| `race_key` | TEXT | Year+MonthDay+JyoCD+Kaiji+Nichiji+RaceNum |
| `umaban` | TEXT | 馬番 |
| `total_score` | REAL | 合計スコア（卍指数相当） |
| `factor_details` | TEXT | JSON: 各ファクターの加減点内訳 |
| `estimated_prob` | REAL | 推定勝率 |
| `fair_odds` | REAL | 適正オッズ（= 1/推定勝率） |
| `actual_odds` | REAL | 実際のオッズ（取得時点） |
| `expected_value` | REAL | 期待値（= 推定勝率 × 実際オッズ） |
| `strategy_version` | TEXT | 戦略バージョン |
| `calculated_at` | TEXT | 計算日時 |

#### 5.2.4 `bets` — 投票指示・記録

| カラム | 型 | 説明 |
|--------|-----|------|
| `bet_id` (PK) | INTEGER | 自動採番 |
| `race_key` | TEXT | レースキー |
| `created_at` | TEXT | 生成日時 |
| `strategy` | TEXT | 戦略モジュール名 |
| `strategy_version` | TEXT | 戦略バージョン |
| `bet_type` | TEXT | WIN/PLACE/EXACTA/TRIFECTA等 |
| `selection` | TEXT | 馬番または組合せ |
| `stake_yen` | INTEGER | 投票金額 |
| `est_prob` | REAL | 推定確率 |
| `odds_at_bet` | REAL | 投票時点オッズ |
| `odds_at_close` | REAL | 確定オッズ。投票時点と確定時点の乖離を追跡 |
| `est_ev` | REAL | 推定期待値 |
| `status` | TEXT | PENDING / EXECUTED / CANCELLED |
| `cancel_reason` | TEXT | キャンセル理由（閾値超過/手動/緊急停止等） |
| `executed_at` | TEXT | 投票実行日時 |
| `result` | TEXT | WIN / LOSE / VOID |
| `payout_yen` | INTEGER | 払戻金額 |
| `factor_details` | TEXT | JSON: 適用ファクターの加減点内訳（監査用） |
| `note` | TEXT | 備考 |

#### 5.2.5 `bankroll_log` — 資金推移ログ

| カラム | 型 | 説明 |
|--------|-----|------|
| `log_id` (PK) | INTEGER | 自動採番 |
| `date` | TEXT | 日付 |
| `opening_balance` | INTEGER | 期首残高 |
| `total_stake` | INTEGER | 投票総額 |
| `total_payout` | INTEGER | 払戻総額 |
| `closing_balance` | INTEGER | 期末残高 |
| `pnl` | INTEGER | 損益 |
| `roi` | REAL | 投資利益率 |
| `note` | TEXT | 備考 |

#### 5.2.6 `backtest_results` — バックテスト結果

| カラム | 型 | 説明 |
|--------|-----|------|
| `bt_id` (PK) | INTEGER | 自動採番 |
| `strategy_version` | TEXT | 戦略バージョン |
| `date_from` | TEXT | 検証期間開始 |
| `date_to` | TEXT | 検証期間終了 |
| `total_races` | INTEGER | 対象レース数 |
| `total_bets` | INTEGER | 総投票数 |
| `total_stake` | INTEGER | 総投票額 |
| `total_payout` | INTEGER | 総払戻額 |
| `pnl` | INTEGER | 損益 |
| `roi` | REAL | ROI |
| `win_rate` | REAL | 的中率 |
| `max_drawdown` | REAL | 最大ドローダウン |
| `sharpe_ratio` | REAL | シャープレシオ相当 |
| `params_json` | TEXT | 実行パラメータJSON |
| `executed_at` | TEXT | 実行日時 |

#### 5.2.7 `data_sync_log` — データ同期ログ

| カラム | 型 | 説明 |
|--------|-----|------|
| `sync_id` (PK) | INTEGER | 自動採番 |
| `started_at` | TEXT | 実行開始日時 |
| `finished_at` | TEXT | 実行完了日時 |
| `exit_code` | INTEGER | JVLinkToSQLiteの終了コード |
| `records_added` | INTEGER | 追加レコード数 |
| `status` | TEXT | SUCCESS / FAILED / TIMEOUT |
| `error_message` | TEXT | エラー内容（失敗時） |

---

## 6. アノマリー発見エンジン

### 6.1 概要

馬券市場におけるアノマリー（市場の非効率性）を体系的に発見し、投資ルールとして活用する。アノマリーの候補は **「年次LLM調査」** と **「常時データ駆動分析」** の2段階で生成する。

### 6.2 Phase 1: 年次LLM調査によるアノマリー候補生成

LLM Gatewayを通じたDeep Research機能を活用し、年1回（年末〜年初）に以下のソースからアノマリー候補を網羅的に調査する。これは大規模な調査であり、毎回実施するものではなく **年次の戦略見直しイベント** として位置づける。

**調査ソース:**

- **学術論文**: 行動経済学・行動ファイナンスにおけるベッティング市場の非効率性研究
- **Favorite-Longshot Bias**: 人気馬の過大評価と穴馬の過小評価に関する古典的アノマリー
- **認知バイアス研究**: アンカリング効果、代表性ヒューリスティック、利用可能性ヒューリスティック
- **海外事例**: 英国・豪州・香港の競馬ベッティング市場の研究
- **日本特有の傾向**: 枠連偏重、単勝軽視、特定騎手への過大評価等
- **卍氏の公開ファクター**: 書籍・インタビュー・ブログで公開された知見の体系化
- **前年の運用実績**: 自システムの実績データから新たな仮説を抽出

**年次調査の運用フロー:**

1. 年末にDeep Researchを実行し、新規アノマリー候補レポートを生成
2. レポートを人間がレビューし、検証すべき候補を選定
3. 選定した候補を`factor_rules`テーブルに`review_status = DRAFT`で登録
4. Phase 2の統計検証に回し、有効性が確認されたものを`APPROVED`に昇格
5. 既存ファクターの有効性低下も同時にレビューし、必要に応じて`DEPRECATED`に変更

#### 6.2.1 アノマリー候補リスト（初期セット）

| ID | アノマリー名 | 仮説 | 検証指標 |
|----|-------------|------|----------|
| A01 | 僅差2着馬の過小評価 | 前走で鼻差〜クビ差の2着馬は実力的に1着馬とほぼ同等だが、オッズでは大きく差がつく | 該当馬の単勝回収率 |
| A02 | 出遅れ馬の過小評価 | 近走で出遅れた馬は実力以上に人気が落ちる | 出遅れ後次走の回収率 |
| A03 | 不利馬の過小評価 | レース中に不利を受けた馬は着順が実力を反映しない | 不利後次走の回収率 |
| A04 | 枠順の偶奇効果 | 統計的に偶数枠・奇数枠で回収率に有意差がある | 枠番別回収率 |
| A05 | ダート→芝転向の過大評価 | ダートで好走した馬が芝に転向すると過大評価される | 転向馬の回収率 |
| A06 | 重馬場好走馬の良馬場での過大評価 | 重馬場で好走した馬が良馬場で走る際に過大評価 | 馬場変化時回収率 |
| A07 | リーディング下位→上位騎手乗替り効果 | 騎手変更による市場の遅延反応 | 乗替り後の回収率 |
| A08 | 休養明けの過小評価 | 長期休養明けの馬が過小評価される傾向 | 休養期間別回収率 |
| A09 | 夏競馬・2歳戦の非効率性 | 情報が少ない条件でオッズの効率性が低下 | 季節別・条件別回収率 |
| A10 | 馬体重の相対順位効果 | 馬体重の絶対値より出走馬内の相対順位が回収率に影響 | 相対馬体重別回収率 |
| A11 | 人気馬の過大評価（Favorite-Longshot Bias） | 1〜2番人気の回収率が低く、中穴（5〜8番人気）に期待値の歪みが存在 | 人気別回収率の分布 |
| A12 | 前走大敗馬の回復パターン | 前走で大差負けの馬が条件変更（距離・馬場）で復活するパターン | 大敗後条件変更時の回収率 |
| A13 | 調教タイム好走馬の過小評価 | 調教タイムが優秀でもレース人気に反映されにくい馬 | 調教タイム上位馬の回収率 |
| A14 | 小回りコース適性の見落とし | 中山・福島等の小回りコースに適性がある馬が東京等の実績で過小評価 | コース替わり時の回収率 |
| A15 | 牝馬の季節性バイアス | 牝馬の好走パターンと季節の関係が市場に十分に織り込まれていない | 牝馬の月別回収率 |

### 6.3 Phase 2: データ駆動によるアノマリー発見

JRA-VANの過去データを用いて、統計解析・機械学習によりアノマリーを発見する。こちらは年次調査とは異なり、**随時実行可能** な自動化プロセスである。

#### 6.3.1 統計的手法

- **条件別回収率分析**: 各条件（枠順、距離、馬場状態等）の組み合わせ別に回収率を算出し、期待回収率75%を有意に上回る条件を抽出
- **χ²検定 / Z検定**: 各ファクターの回収率が偶然でないことを統計的に検証（p < 0.05）
- **多重比較補正**: Bonferroni補正またはFDR制御により、多重検定による偽陽性を抑制

#### 6.3.2 データスヌーピングバイアスへの対策

多数の条件を網羅的に検証する場合、偶然による「見かけのアノマリー」が発見されるリスクがある。以下の対策を必須とする:

1. **サンプル分割**: データを訓練セット（60%）・検証セット（20%）・テストセット（20%）に分割。訓練セットで発見したアノマリーを検証セットで確認し、テストセットで最終評価
2. **最小サンプル数**: 各アノマリーの評価には最低100レース以上のサンプルを要求
3. **効果量の閾値**: 統計的有意性（p値）だけでなく、実用的な効果量（回収率改善幅 > 10%）を要求
4. **時系列安定性**: 複数の時間ウィンドウ（年度別）でアノマリーの一貫性を確認

#### 6.3.3 機械学習による特徴量重要度分析

- LightGBM / XGBoostで「回収率が高い馬」を予測するモデルを構築し、特徴量重要度からアノマリー候補を抽出
- **SHAP値分析** により、各特徴量がオッズの非効率性にどう寄与しているかを可視化

---

## 7. ファクタールール管理

本システムの競争力の源泉はファクタールールの質と鮮度にある。ルールの作成・編集・検証・無効化の全ライフサイクルをダッシュボードから管理できる。

### 7.1 ルールのライフサイクル

```
[DRAFT] → [TESTING] → [APPROVED] → [DEPRECATED]
   ↑          ↓             ↓
   └── 差戻し ┘        [重み調整]
```

| ステータス | 説明 |
|-----------|------|
| **DRAFT** | 新規作成・AI生成直後。本番スコアリングには使用されない |
| **TESTING** | バックテスト検証中。検証結果がダッシュボードに表示される |
| **APPROVED** | 本番運用中。スコアリングエンジンが使用する |
| **DEPRECATED** | 無効化済み。過去の記録として保持するが、スコアリングには使用しない |

### 7.2 ルールの追加フロー

1. **手動追加**: ダッシュボードの「ファクター管理」タブからフォーム入力で作成。SQL式またはPython式でルールを定義
2. **AI生成**: AIエージェントが発見したアノマリーから自動的にルール候補を生成。`DRAFT`として登録
3. **インポート**: CSVまたはJSON形式でルール定義を一括インポート

### 7.3 ルールの見直し・更新フロー

1. **四半期レビュー**: 全`APPROVED`ルールのバックテストを自動実行し、有効性スコアをダッシュボードに表示
2. **劣化検知**: `decay_rate`が閾値を超えたルールに自動アラートを発報
3. **重み調整**: ダッシュボードから個別ルールの重みをスライダーで調整可能。変更履歴は`factor_review_log`に自動記録
4. **一括無効化**: 有効性スコアが閾値を下回ったルールの一括`DEPRECATED`化
5. **A/Bテスト**: 新旧ルールセットの並行バックテストによる比較評価

### 7.4 ルール変更の安全策

- 全ての変更は`factor_review_log`に記録され、誰が・いつ・なぜ変更したか追跡可能
- `APPROVED`ルールの重み変更は、変更前後のバックテスト比較を表示してから確定
- ルール削除は不可（`DEPRECATED`への変更のみ。データの不変性を保証）
- AIエージェントが生成したルールは、人間の承認なしに`APPROVED`に昇格しない

---

## 8. スコアリングエンジン

### 8.1 スコア計算方式

卍指数方式に倣い、各馬に対して複数のファクタールールを適用し、合計スコアを算出する。基準値100を中心とし、過小評価されている馬ほど高スコアとなる。

**計算式:**

```
total_score = 100 + Σ(factor_weight_i × rule_result_i)
```

- `rule_result_i`: 各ファクタールールの判定結果（+1, 0, -1等）
- `factor_weight_i`: そのルールの重み（バックテストの回収率改善への寄与度から決定）
- `APPROVED`かつ`is_active = 1`かつ有効期間内のルールのみが適用対象

### 8.2 期待値計算

スコアから推定確率を導出し、実際のオッズと比較して期待値を算出する:

```python
estimated_prob = score_to_prob(total_score)   # 確率校正モデルで変換
fair_odds      = 1.0 / estimated_prob
expected_value = estimated_prob * actual_odds
# EV > 1.0 の馬券を「割安」と判定し、投票候補とする
```

### 8.3 確率校正（Calibration）

スコアから確率への変換は、システム全体の精度を左右する最重要プロセスである。以下の校正手法を実装する:

1. **Plattスケーリング**: ロジスティック回帰によるスコア→確率変換
2. **Isotonic Regression**: 単調性を保証するノンパラメトリック校正
3. **校正曲線の定期検証**: 月次で校正精度（Brier Score）を検証し、劣化時は再校正

校正なしに生スコアをそのまま確率として使用することは禁止する。

### 8.4 投票金額決定ロジック

卍氏の資金管理手法を参考に、以下のルールで投票金額を決定する:

| 方式 | 計算式 | 特徴 |
|------|--------|------|
| **均等配分** | `unit_yen = bankroll × fixed_rate` | 最もシンプル。固定比率（例: 残高の0.5%）で均等投票 |
| **期待値比例** | `unit_yen = base × (EV - 1.0) × scaling` | 期待値が高いほど投票額を増やす |
| **Kelly基準** | `f* = (p × b - q) / b` | 理論上最適だが分散が大きいため、**Quarter Kelly（Kelly×0.25）を推奨** |
| **上限制約** | `max_stake = bankroll × max_rate` | 1レースあたりの最大投票比率を制限（例: 残高の5%） |

**資金管理の安全策:**

- **Kelly基準の危険性**: フルKellyは確率推定の誤差に極めて敏感である。推定確率が5%ずれるだけで破産リスクが劇的に上昇するため、Quarter Kelly（Kelly × 0.25）を推奨する
- **ドローダウン連動型**: 最大ドローダウンが30%を超えた場合、自動的に投票額を50%に縮小
- **段階的復帰**: ドローダウンからの回復期は、投票額を段階的に元の水準に戻す

---

## 9. バックテストエンジン

### 9.1 設計原則

バックテストはライブ実行と **同一のコード・同一のデータパイプライン** を使用する（Look-Ahead Biasの防止）。

- **Survivorship Bias対策**: 途中で除外・引退した馬のデータも含める
- **時間軸の厳密管理**: 各時点で「その時点で入手可能だったデータのみ」を使用するpoint-in-time分析を徹底
- **スリッページモデル**: 投票時点オッズと確定オッズの乖離をモデル化し、バックテストに反映

### 9.2 バックテスト項目

| テスト種別 | 目的 | 手法 |
|-----------|------|------|
| ファクター単体検証 | 各ファクタールールの回収率改善効果を検証 | 該当条件の馬のみで単勝回収率を算出。ブートストラップ法で信頼区間を付与 |
| ファクター組合せ検証 | 複数ファクターの相乗効果を検証 | ファクターを段階的に追加し、回収率の改善度合いを確認 |
| フルストラテジー検証 | スコアリング＋投票金額決定まで含めた全体検証 | 擬似投票を行い、累積P&L・ROI・最大ドローダウンを算出 |
| ウォークフォワード検証 | 過適合（オーバーフィッティング）の防止 | 訓練期間とテスト期間をスライドさせ、未知期間での性能を確認 |
| モンテカルロシミュレーション | 戦略のロバスト性を評価 | レース順序をランダムにシャッフルし、P&Lの分布を推定 |
| ストレステスト | 極端な相場環境での耐性を検証 | 最大連敗数、最悪月の損失、回復期間を評価 |

### 9.3 KPI指標

| 指標 | 定義 | 目標値 |
|------|------|--------|
| P&L（損益） | 総払戻額 - 総投票額 | プラス |
| ROI（投資利益率） | P&L / 総投票額 × 100 | > 5% |
| 的中率 | 的中数 / 総投票数 × 100 | 戦略依存 |
| 回収率 | 総払戻額 / 総投票額 × 100 | > 105% |
| 最大ドローダウン | ピークからの最大下落率 | < 50% |
| 連敗最大数 | 連続不的中の最大回数 | 戦略依存 |
| シャープレシオ相当 | 日次リターンの平均 / 標準偏差 | > 0.5 |
| Calmar Ratio | 年間リターン / 最大ドローダウン | > 0.5 |
| 回復期間（Recovery Time） | 最大ドローダウンからのピーク回復に要する期間 | < 3ヶ月 |
| Profit Factor | 総利益 / 総損失 | > 1.2 |
| 月次勝率 | 月単位でプラス収支の割合 | > 60% |
| 1レースあたりベット数 | 平均ベット数/レース | 安定性指標 |

---

## 10. 自動投票エンジン

### 10.1 JRA IPAT連携方式

JRA公式のインターネット投票サービス（IPAT）との連携は以下の2方式をサポートする:

| 方式 | 技術 | 特徴 |
|------|------|------|
| **Selenium方式** | Python + Selenium + Chrome | IPATのWeb画面を自動操作。環境構築が容易だがUI変更に弱い |
| **ipatgo方式** | ipatgo (JRA-VAN提供) | JRA-VAN DataLab会員向けの投票ツール。ファイルモードでCSVから一括投票可能。APIの信頼性が高い |

### 10.2 投票フロー

1. スコアリングエンジンがベットリスト（`bets`テーブル）を生成
2. 直前オッズを取得し、EV閾値でフィルタリング
3. 投票金額を資金管理ロジックで決定
4. 投票ファイル（CSV）を生成
5. Selenium / ipatgoでIPATに自動投票
6. 投票完了確認 → `bets`テーブルの`status`を`EXECUTED`に更新
7. レース確定後、結果を自動取込し`result`・`payout_yen`を更新

### 10.3 安全機構

| 制御 | 内容 |
|------|------|
| **日次投票上限** | 1日の総投票額に上限を設定（例: bankrollの20%） |
| **1レース上限** | 1レースの投票額に上限を設定（例: bankrollの5%） |
| **承認モード** | 自動投票前に人間の承認を要求するモード（オプション） |
| **緊急停止** | 連敗数または日次損失額が閾値を超えた場合に自動停止 |
| **ドライラン** | 実際に投票せずにシミュレーションのみ実行するモード |
| **投票ログ** | 全投票をタイムスタンプ付きで記録し監査可能 |
| **二重投票防止** | 同一レース・同一馬番への重複投票を検出・防止するロック機構 |
| **オッズ急変検知** | 投票判断時のオッズと直前オッズが一定割合以上乖離した場合、投票を保留 |
| **セッション監視** | IPAT接続セッションの有効性を継続的に監視。切断時は即座にリトライまたは停止 |
| **運用初期モード** | 運用開始後最初の1ヶ月は投票金額を通常の10%に制限し、システム動作を検証 |

---

## 11. ダッシュボード仕様

### 11.1 デザイン方針

プロフェッショナルな金融ダッシュボードとして、以下のWebデザインベストプラクティスを適用する。

#### ビジュアルデザイン原則

| 原則 | 実装 |
|------|------|
| **ダークモード優先** | 長時間モニタリングに適したダーク基調テーマ。ライトモード切替可能 |
| **カラーパレット** | メイン: `#0D1117`（背景）、アクセント: `#58A6FF`（情報）・`#3FB950`（利益/正）・`#F85149`（損失/負）・`#D29922`（警告） |
| **タイポグラフィ** | 数値表示: 等幅フォント（JetBrains Mono）。本文: Noto Sans JP。視認性と日本語の美しさを両立 |
| **データ密度** | 情報密度を高く保ちつつ、余白（padding: 16-24px）で読みやすさを確保 |
| **レスポンシブ** | `st.columns()`による2-3カラムレイアウト。KPIカードは横並び4枚構成 |
| **一貫性** | 全タブで同一のカードスタイル、ボタンスタイル、カラーコードを使用 |

#### チャート・グラフ仕様（Plotly）

| 用途 | チャートタイプ | 設計詳細 |
|------|-------------|----------|
| **累積P&L推移** | `plotly.graph_objects.Scatter` (area fill) | 利益域を半透明グリーン、損失域を半透明レッドで塗り分け。ホバーで日付・P&L・ROIを表示 |
| **ドローダウン推移** | `go.Scatter` (inverted area) | Y軸反転の赤いエリアチャート。最大DDポイントにマーカー付与 |
| **月次P&Lヒートマップ** | `go.Heatmap` | 年×月のマトリクス。赤緑のダイバージングカラースケール。数値ラベル付き |
| **ファクター有効性ヒートマップ** | `go.Heatmap` | ファクター×期間のマトリクス。回収率をカラーマップで表現 |
| **人気別回収率分布** | `go.Bar` + 水平ライン(75%) | 棒グラフに控除率ライン（75%）を重ね、期待値超過を視覚化 |
| **エクイティカーブ** | `go.Scatter` (multi-trace) | 複数戦略の資産推移曲線を重ね描き。対数スケール切替可能 |
| **KPIカード** | `st.metric()` + カスタムCSS | 大きな数値 + delta表示（前期比）。カード形状にbox-shadow付き |
| **ファクターレーダーチャート** | `go.Scatterpolar` | 各カテゴリーのファクタースコアをレーダーチャートで可視化 |
| **投票実績テーブル** | `streamlit-aggrid` | ソート・フィルタ・ページネーション対応のインタラクティブテーブル |
| **リアルタイムオッズ** | `go.Indicator` (gauge) | 各馬のオッズをゲージチャートで表示。EV > 1.0の馬をハイライト |

#### カスタムCSS

```css
/* ダッシュボード全体のダークテーマ */
.stApp {
  background-color: #0D1117;
  color: #C9D1D9;
}

/* KPIカード */
.kpi-card {
  background: linear-gradient(135deg, #161B22 0%, #1C2128 100%);
  border: 1px solid #30363D;
  border-radius: 12px;
  padding: 20px 24px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.kpi-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 2.4rem;
  font-weight: 700;
}

.kpi-positive { color: #3FB950; }
.kpi-negative { color: #F85149; }
.kpi-neutral  { color: #58A6FF; }

/* テーブルのストライプ */
.styled-table tr:nth-child(even) {
  background-color: #161B22;
}
```

### 11.2 タブ構成

#### Tab 1: データ管理

- JVLinkToSQLiteの実行状態・最終更新日時の表示（ステータスバッジ: 緑=正常 / 黄=遅延 / 赤=エラー）
- DB内のレコード件数サマリー（レース数、出走馬数、年度別件数）— 棒グラフで年度推移を可視化
- `data_sync_log`テーブルからの同期履歴タイムライン
- データ品質チェック結果の表示（欠損値率、異常値検出数）
- 手動データ取込トリガーボタン

#### Tab 2: ファクター管理

ルールの全ライフサイクルを管理するメインタブ。

**一覧表示エリア:**
- `streamlit-aggrid`によるインタラクティブテーブル。カラム: ルール名、カテゴリー、重み、有効性スコア、ステータス、最終更新日
- ステータスでフィルタリング（DRAFT / TESTING / APPROVED / DEPRECATED）
- 有効性スコアでソート可能

**ルール追加・編集フォーム:**
- サイドバーまたはモーダルで表示
- フィールド: ルール名、カテゴリー（ドロップダウン）、説明、SQL式/Python式（コードエディタ）、重み（スライダー）、出典
- 「テスト実行」ボタン: 入力した式を過去データで即座に検証し、回収率と該当件数を表示
- 「下書き保存」→ `DRAFT`で登録、「バックテスト開始」→ `TESTING`に移行

**ルール詳細パネル:**
- 各ファクターの回収率推移グラフ（`go.Scatter` — 月次推移）
- ファクター有効性のヒートマップ（条件×期間マトリクス）
- 変更履歴（`factor_review_log`のタイムライン表示）
- 劣化アラート表示（有効性スコアが閾値を下回った場合の警告バナー）

**一括操作:**
- 四半期レビュー用の「全ルール再検証」ボタン
- 有効性スコア閾値による一括フィルタ → 一括DEPRECATED化

#### Tab 3: 戦略実行

- 当日の対象レース一覧（競馬場・レース番号・条件をカード形式で表示）
- 各馬のスコア表示（ファクターレーダーチャート + スコア内訳テーブル）
- オッズ vs 適正オッズの比較棒グラフ
- ベットリスト生成・確認・承認（EV値でハイライト色分け）
- 投票実行ボタン・ステータスモニター（プログレスバー + リアルタイムログ）

#### Tab 4: P&Lダッシュボード

- **KPIカード行**: ROI、回収率、的中率、最大DD、シャープレシオ、Profit Factor（前期比delta付き）
- 累積P&L推移グラフ（日次/週次/月次切替。利益/損失域の色分けエリアチャート）
- ドローダウン推移グラフ（Y軸反転赤エリア）
- 月次P&Lヒートマップ（年×月マトリクス）
- 馬券種別・競馬場別・条件別の収支分析（ドリルダウン対応のツリーマップ or サンバースト）
- ベンチマーク比較（全体回収率75%ラインとの差分表示）

#### Tab 5: バックテスト

- 期間・戦略・パラメータを選択して実行（サイドバーにパラメータフォーム）
- バックテスト結果の比較テーブル（複数バージョンの横並び比較）
- エクイティカーブ（資産推移曲線）の可視化（複数戦略重ね描き対応）
- ウォークフォワード結果の時系列表示
- モンテカルロシミュレーションの分布グラフ（信頼区間付きファンチャート）

#### Tab 6: AIアシスタント

- LLMとの対話チャットUI（`st.chat_message`ベース）
- 週次レポートの自動生成・表示（成績サマリー・改善提案）
- 自然言語でのデータ分析クエリ実行（Text-to-SQL）
- 年次アノマリー調査の実行トリガーと結果表示
- AI生成ルール候補の一覧と「ファクター管理へ送る」ボタン

---

## 12. LLM/AIエージェント活用機能

### 12.1 LLM Gateway — マルチプロバイダー統合

全てのLLM機能は **LLM Gateway（抽象化層）** を経由し、**Azure AI Foundry** と **GCP Vertex AI** の両プロバイダーを統一的に利用する。これにより、モデルの切替・コスト最適化・可用性確保を実現する。

#### プロバイダー構成

| プロバイダー | 利用可能モデル | 特徴 |
|-------------|---------------|------|
| **Azure AI Foundry** | Claude Opus 4.6, GPT-5.2, その他 | Microsoftエコシステムとの親和性。GPTモデルの安定供給 |
| **GCP Vertex AI** | Gemini 3.0 Pro Preview, Gemini 3.0 Flash Preview, Claude Opus 4.6 | Googleモデルへのアクセス。Flash系の高速・低コスト |

#### 用途別モデル選定

| 用途 | プライマリモデル | フォールバック | 選定理由 |
|------|----------------|---------------|----------|
| **年次アノマリー調査（Deep Research）** | Claude Opus 4.6 (Azure/Vertex) | Gemini 3.0 Pro | 長文の学術論文分析、複雑な推論が必要 |
| **ファクタールール自動生成** | Claude Opus 4.6 | GPT-5.2 | コード生成精度が重要。SQL式・Python式の品質 |
| **週次レポート生成** | Gemini 3.0 Pro | GPT-5.2 | 構造化されたレポート出力。コスト効率重視 |
| **自然言語→SQLクエリ変換** | Claude Opus 4.6 | Gemini 3.0 Pro | SQL生成精度とJVLinkスキーマの理解が重要 |
| **戦略最適化提案** | Claude Opus 4.6 | GPT-5.2 | 複雑なデータ分析結果の解釈と提案 |
| **異常検知アラートの解釈** | Gemini 3.0 Flash | GPT-5.2 | 短い判断テキスト。レイテンシとコスト重視 |
| **レース分析コメント** | Gemini 3.0 Flash | GPT-5.2 | 当日運用中のリアルタイム分析。速度重視 |

#### LLM Gateway設計方針

- **プロバイダー抽象化**: 呼び出し側はモデル名のみ指定し、どのプロバイダー経由かを意識しない
- **自動フォールバック**: プライマリモデルが利用不可の場合、設定に基づきセカンダリモデルに自動切替
- **モデル追加の容易さ**: `config.yaml`での設定変更のみで新モデルを追加可能。コード変更不要
- **コストルーティング**: 用途の重要度に応じて高性能モデル/低コストモデルを自動振り分け

### 12.2 エージェント一覧

| 機能 | 説明 | 実行頻度 |
|------|------|----------|
| **アノマリー調査エージェント** | Deep Researchを使い、学術論文・ニュース・海外事例からアノマリー候補を自動探索 | **年1回**（年末〜年初） |
| **ファクター生成エージェント** | 発見したアノマリーからSQL式・Python関数形式のファクタールールを自動生成。`DRAFT`として登録 | 年次調査後 + 随時 |
| **週次レポート生成** | 運用成績を分析し、改善提案付きのレポートをMarkdownで自動生成 | 毎週月曜 |
| **自然言語クエリ** | 「先月の芝レースで回収率が高かった条件は？」等の質問に対しSQLを自動生成・実行 | ユーザー操作時 |
| **戦略最適化エージェント** | バックテスト結果を分析し、ファクターの重み調整やパラメータチューニングを提案 | 四半期レビュー時 |
| **異常検知エージェント** | ファクターの有効性低下（ドリフト）を監視し、アラートを発報・解釈コメントを付与 | 日次自動実行 |
| **レース分析エージェント** | 当日のレース特性（コース・馬場・出走馬構成）を分析し、戦略パラメータの調整を提案 | 土日当日 |

### 12.3 AIエージェントの品質管理

- **LLM出力の検証**: AIが生成したファクタールールは、必ず人間がレビューし、バックテストで有効性を確認してから本番適用する（`DRAFT` → `TESTING` → `APPROVED`フロー）
- **プロンプトのバージョン管理**: 各エージェントのプロンプトもGitで管理し、変更履歴を追跡する
- **コスト管理**: 全プロバイダー（Azure AI Foundry / GCP Vertex AI）の使用量を月次で集計し、エージェント別・モデル別のコスト内訳をダッシュボードに表示
- **フォールバック**: プライマリモデルが利用不可の場合、セカンダリモデルに自動切替

---

## 13. JVLinkToSQLite連携設計

### 13.1 JVLinkToSQLite概要

JVLinkToSQLiteはurasandesu氏が開発したOSSツール（GPL-3.0）で、JRA-VAN DataLabのJV-Link APIを通じて競馬データをSQLiteに変換する。C#/.NETで実装されており、Windows環境で動作する。

### 13.2 セットアップ手順

1. JRA-VAN DataLab会員登録（月額2,090円）、JV-Linkインストール
2. JVLinkToSQLiteをダウンロード・展開
3. 初期設定: `.\jvlinktosqlite -m init`
4. 初回全量取得: `.\jvlinktosqlite -m exec`（数時間〜1日）
5. `setting.xml`で取得対象データを設定（オッズデータは大量のため取捨選択可能）

### 13.3 自動更新スケジュール

Windows Task Schedulerで以下のスケジュールを設定:

| タイミング | コマンド | 目的 |
|-----------|---------|------|
| 毎週水曜 18:00 | `.\jvlinktosqlite -m exec` | 出走表・登録馬データの取得 |
| 毎週金曜 21:00 | `.\jvlinktosqlite -m exec` | 枠順確定・前日オッズの取得 |
| 土日 各レース後 | `.\jvlinktosqlite -m exec` | 確定結果・払戻データの取得 |
| 毎週月曜 06:00 | `.\jvlinktosqlite -m exec` | 週末全データの最終同期 |

各実行のexit codeと処理結果は`data_sync_log`テーブルに記録する。実行失敗時はSlack/メール通知を送信し、連続3回失敗時は管理者にエスカレーションする。

### 13.4 Python連携

JVLinkToSQLiteが生成するSQLiteファイルに対し、Pythonから`sqlite3`モジュールで直接アクセスする。DBファイルのパスは`config.yaml`で管理する。

---

## 14. 戦略エンジンインターフェース

### 14.1 Strategyプラグイン規約

戦略はプラグイン方式のPythonモジュールとして実装する。各戦略は以下のインターフェースを実装しなければならない:

```python
from abc import ABC, abstractmethod
from dataclasses import dataclass
from typing import Any


@dataclass
class Bet:
    """投票指示データクラス"""
    race_key: str
    bet_type: str          # WIN/PLACE/EXACTA/TRIFECTA等
    selection: str          # 馬番または組合せ
    stake_yen: int
    est_prob: float
    odds_at_bet: float
    est_ev: float
    factor_details: dict    # 各ファクターの加減点内訳


class Strategy(ABC):
    """戦略プラグインの基底クラス"""

    @abstractmethod
    def name(self) -> str:
        """戦略名を返す"""
        ...

    @abstractmethod
    def version(self) -> str:
        """戦略バージョンを返す（例: "1.0.0"）"""
        ...

    @abstractmethod
    def run(
        self,
        race_data: dict,
        entries: list[dict],
        odds: dict,
        bankroll: int,
        params: dict[str, Any],
    ) -> list[Bet]:
        """
        戦略を実行し、投票指示リストを返す。

        Args:
            race_data: レース情報（NL_RAのレコード）
            entries: 出走馬リスト（NL_SEのレコード群）
            odds: オッズ情報（馬番→オッズのdict）
            bankroll: 現在の残高
            params: 戦略パラメータ

        Returns:
            投票指示のリスト。投票対象なしの場合は空リスト。
        """
        ...
```

### 14.2 戦略ルール

- **決定論的** であること（同一入力に対し同一出力を保証）
- **DBへの直接書込みを行わない** こと
- 全ての判断根拠（確率、EV、適用ファクター）を返却すること
- Gitでバージョン管理し、変更履歴を追跡可能にすること

### 14.3 プラグインのバリデーション

新しい戦略プラグインは、本番適用前に以下の自動チェックをパスする必要がある:

1. **決定論性テスト**: 同一入力で10回実行し、全て同一出力であることを確認
2. **型チェック**: `mypy --strict`による静的型検査
3. **パフォーマンステスト**: 1レースあたりの処理時間 < 1秒
4. **バックテスト合格**: 直近1年のデータで回収率100%以上（または管理者承認）

---

## 15. ガバナンスと管理

| 管理項目 | 実装方法 |
|---------|----------|
| **意思決定の追跡可能性** | betsテーブルに戦略名・バージョン・パラメータ・各ファクタースコアを記録 |
| **データの不変性** | オッズスナップショットはappend-only。結果データは更新のみ（削除不可） |
| **監査証跡** | 全投票にタイムスタンプ付きログ。投票ファイルも保存 |
| **戦略バージョニング** | Gitタグでバージョン管理。本番適用前にバックテスト合格が必要 |
| **ルール変更履歴** | `factor_review_log`に全変更を記録。変更者・理由・バックテスト結果を保持 |
| **リスク制限** | 日次/月次の投票上限、連敗時の自動停止、ドローダウン警告 |
| **セキュリティ** | IPAT認証情報・LLM APIキー（Azure / GCP）は環境変数または暗号化ファイルで管理。平文保存禁止 |

### 15.1 税務対応

馬券裁判の判例に基づき、外れ馬券を経費算入するためには **「営利を目的とする継続的行為から生じた所得」** であることを証明する必要がある。

- 全ての投票記録・収支記録を税務調査に耐えうる形式で保持する
- 年次の確定申告用サマリーレポートを自動生成する機能を実装する
- **記録すべき項目**: 投票日時、レース名、馬券種別、投票金額、オッズ、結果、払戻金額

---

## 16. 非機能要件

| カテゴリー | 要件 |
|-----------|------|
| **性能** | 1レースあたりのスコアリング処理 < 1秒。全レースのバックテスト（1年分）< 10分 |
| **可搬性** | Windows（JVLinkToSQLite実行）+ Mac/Linux（分析・ダッシュボード実行） |
| **信頼性** | SQLite WALモードによる書込み耐障害性。自動バックアップ |
| **セキュリティ** | 認証情報の暗号化保存。ログにパスワード・APIキーを出力しない |
| **拡張性** | Strategy / Factor / DataProviderのプラグインアーキテクチャ |
| **運用性** | エラー時のメール/Slack通知。ログレベルによる出力制御 |
| **バックアップ** | SQLite DBの日次自動バックアップ。直近30日分を保持。バックアップの整合性を定期検証 |
| **監視** | 主要プロセスの死活監視。ダッシュボードの応答時間 < 3秒 |
| **テスト** | コードカバレッジ80%以上。CIによる自動テスト実行 |
| **UI応答性** | ダッシュボードの初期ロード < 3秒。チャート描画 < 1秒。タブ切替 < 500ms |

---

## 17. 開発ロードマップ

| フェーズ | 期間目安 | 内容 | ゲート条件 |
|---------|---------|------|-----------|
| **Phase 0: 基盤構築** | Week 1-2 | JVLinkToSQLiteセットアップ、DB連携確認、プロジェクト骨格構築 | DBアクセスの動作確認、テストデータでのクエリ実行成功 |
| **Phase 1: アノマリー調査** | Week 3-4 | LLMによる候補リスト作成、初期ファクター定義、統計検証 | 最低10個のアノマリー候補を統計的に検証済み |
| **Phase 2: スコアリングエンジン** | Week 5-6 | ファクター統合、スコア計算、期待値算出ロジック実装 | スコアリングの決定論性テスト合格 |
| **Phase 3: バックテスト** | Week 7-8 | バックテストエンジン実装、ウォークフォワード検証、KPI算出 | ウォークフォワード検証で回収率100%以上を確認 |
| **Phase 4: ダッシュボード** | Week 9-10 | Streamlit UI構築、P&L可視化、ファクター管理画面、バックテスト結果表示 | 全タブが動作し、KPIが正しく表示される |
| **Phase 5: 自動投票** | Week 11-12 | IPAT連携実装、安全機構実装、ドライラン検証 | ドライランで1ヶ月間のシミュレーション完了 |
| **Phase 6: AI連携** | Week 13-14 | LLM Gatewayエージェント統合（Azure + Vertex AI）、レポート自動生成、自然言語クエリ | 全機能の結合テスト合格、少額テスト投票の成功確認 |
| **Phase 7: 運用開始** | Week 15- | 少額実投票開始、パラメータ調整、継続改善 | — |

---

## 18. リポジトリ構成

リポジトリ名: `keiba-data-analytics`

```
keiba-data-analytics/
├── config/
│   ├── config.yaml           # メイン設定（DBパス、閾値、LLM Gateway設定等）
│   ├── config.example.yaml   # テンプレート（リポジトリに含める。config.yamlは.gitignore対象）
│   └── setting.xml           # JVLinkToSQLite設定
├── src/
│   ├── __init__.py
│   ├── data/
│   │   ├── __init__.py
│   │   ├── db.py             # SQLite接続・クエリ実行
│   │   ├── provider.py       # データプロバイダー（JVLink DBラッパー）
│   │   └── validator.py      # データ品質チェック
│   ├── factors/
│   │   ├── __init__.py
│   │   ├── registry.py       # ファクタールール登録・管理・CRUD
│   │   ├── base.py           # ファクター基底クラス
│   │   ├── lifecycle.py      # ライフサイクル管理（DRAFT→APPROVED→DEPRECATED）
│   │   ├── reviewer.py       # 自動レビュー・劣化検知
│   │   └── rules/            # 個別ファクタールール実装
│   ├── scoring/
│   │   ├── __init__.py
│   │   ├── engine.py         # スコアリングエンジン本体
│   │   └── calibration.py    # 確率校正（Platt / Isotonic）
│   ├── strategy/
│   │   ├── __init__.py
│   │   ├── base.py           # Strategy基底クラス
│   │   └── plugins/          # 戦略プラグイン
│   ├── backtest/
│   │   ├── __init__.py
│   │   ├── engine.py         # バックテストエンジン本体
│   │   └── metrics.py        # KPI計算
│   ├── betting/
│   │   ├── __init__.py
│   │   ├── executor.py       # 投票実行（Selenium/ipatgo）
│   │   ├── safety.py         # 安全機構
│   │   └── bankroll.py       # 資金管理
│   ├── dashboard/
│   │   ├── __init__.py
│   │   ├── app.py            # Streamlitメインアプリ
│   │   ├── theme.py          # テーマ・カスタムCSS定義
│   │   ├── components/       # 再利用可能UIコンポーネント（KPIカード等）
│   │   └── pages/            # タブ別ページモジュール
│   ├── llm_gateway/
│   │   ├── __init__.py
│   │   ├── gateway.py        # LLM Gateway本体（プロバイダー抽象化）
│   │   ├── azure_provider.py # Azure AI Foundryプロバイダー
│   │   ├── vertex_provider.py# GCP Vertex AIプロバイダー
│   │   └── config.py         # モデル選定・フォールバック設定
│   └── agents/
│       ├── __init__.py
│       ├── base.py           # エージェント基底クラス（LLM Gatewayクライアント）
│       ├── anomaly.py        # アノマリー調査エージェント
│       ├── factor_gen.py     # ファクター生成エージェント
│       ├── reporter.py       # レポート生成エージェント
│       └── nl_query.py       # 自然言語クエリエージェント
├── scripts/
│   ├── setup_scheduler.ps1   # Task Scheduler設定スクリプト
│   └── init_db.py            # 拡張テーブル初期化
├── tests/
│   ├── test_factors/
│   ├── test_scoring/
│   ├── test_backtest/
│   └── test_betting/
├── notebooks/                # Jupyter分析ノートブック
├── docs/                     # ドキュメント
├── .env.example              # 環境変数テンプレート
├── .gitignore
├── pyproject.toml
└── README.md
```

---

## 19. Claude Code実装プロンプト

以下のプロンプトをClaude Codeでの実装時に使用する:

```
あなたはシニアPythonエンジニアです。
「Keiba Data Analytics（競馬定量投資プラットフォーム）」プロジェクトに取り組んでいます。
以下のモジュールを技術仕様書に従って実装してください:

- JVLinkToSQLiteが生成するSQLiteデータベースのスキーマ（NL_RA, NL_SE等）に準拠すること
- プラグインアーキテクチャに従い、既存インターフェースを変更しないこと
- 再現性と決定論的動作を保証すること
- 本番品質の可読性の高いコードを書くこと
- 日本語のコメント・docstringを含めること
- LLM連携はLLM Gateway（Azure AI Foundry / GCP Vertex AI）を使用すること

実装対象モジュール: [ここにモジュール名を記載]
期待される動作: [ここに機能説明を記載]
エッジケース: [ここにエッジケースを列挙]
```

---

## 20. 免責事項

- 本システムは **分析・研究・教育目的** で設計されている
- 馬券の購入は利用者の **自己責任** で行い、適用法令・JRA利用規約・各種サービスの利用規約を遵守すること
- 本システムの利用により生じたいかなる損失についても、開発者は責任を負わない
- JRA-VAN DataLabのデータは、JRA-VANの利用規約に従って使用すること。データの再配布は禁止されている
- **馬券投資は元本保証されない投機的行為** であり、過去のバックテスト結果が将来のリターンを保証するものではない
- 自動投票プログラムの使用がJRA IPAT利用規約に抵触しないか、事前に確認すること
- 馬券の払戻金は所得税法上「一時所得」または「雑所得」に分類される。本システムのように継続的・網羅的に購入する場合は「雑所得」として申告が必要となる可能性が高い（馬券裁判判例参照）
- 年間の利益が一定額を超える場合は確定申告が必要。税理士への相談を推奨

---

*— End of Document —*

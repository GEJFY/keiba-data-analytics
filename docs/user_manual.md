# Keiba Data Analytics ユーザーマニュアル

## 1. システム概要

### GY指数方式バリュー投資とは

Keiba Data Analytics は、JRA-VAN DataLab の競馬データを定量分析し、**期待値（EV）ベースのバリュー投資**を行うためのシステムです。

一般的な競馬予想は「どの馬が勝つか」を当てることに集中しますが、本システムの考え方は異なります。

> **バリュー投資の原則**: 馬券のオッズが「本来あるべき確率」より高い場合、それは割安な投資機会（バリューベット）である。長期的にバリューベットだけを買い続ければ、理論上プラスのリターンが得られる。

例えば、ある馬の実力から推定した勝率が10%で、単勝オッズが15倍（暗示確率6.7%）の場合、市場はこの馬を過小評価しています。期待値（EV）= 0.10 x 15.0 = **1.50** となり、1.0を大きく上回るバリューベットです。

### システム全体の流れ

```text
JVLink同期 → ファクタースコアリング → EV算出 → バリューベット抽出 → 投票 → 結果照合
     |              |                    |              |                |          |
  データ取込   各馬にGY指数を付与   確率×オッズ    EV>1.05の馬      資金管理    収支記録
```

---

## 2. クイックスタート

### 初回セットアップ

1. **`setup.bat` をダブルクリック**（5-10分）
   - Python環境・仮想環境の作成
   - 依存パッケージのインストール
   - ダミーデータの自動生成（36レース分）
   - テストの自動実行
2. **設定ファイルを編集**
   - `config/config.yaml`: DB パス、LLM設定
   - `.env`: API キー（AI機能を使う場合）
3. **`run.bat` をダブルクリック** → メニューから `1` を選択

ブラウザで `http://localhost:8501` が自動で開きます。

### 最初のバックテストまでの手順

```text
Step 1: run.bat → ダッシュボード起動
Step 2: ファクター管理タブ → 初期ファクター（25個）がAPPROVED状態で登録済みか確認
Step 3: バックテストタブ → 日付範囲・初期資金を入力 → 「バックテスト実行」
Step 4: ROI・勝率・最大DDの結果を確認
```

ダミーデータでもバックテストは実行可能です。本番データを使う場合は「データ管理」タブからJVLink同期を実行してください。

---

## 3. ダッシュボード操作ガイド

### 3.1 データ管理

データの取込・状態確認・管理を行うページです。

- **データソースバナー**: 黄色=ダミーデータ、緑=本番データ、青=データなし
- **JVLink同期**: 「JVLink同期を実行」ボタンでJVLinkToSQLite.exeを起動し最新データを取込
- **品質チェック**: 各テーブルの欠損率を診断
- **レース一覧**: 取込済みレースを日付・競馬場・距離で確認
- **拡張データ削除**: スコアリング結果や投票履歴を個別にクリア可能（ファクタールールは保護）

### 3.2 ファクター管理

ファクター（馬の評価指標）の作成・ステータス管理を行います。

```text
DRAFT（下書き） → TESTING（検証中） → APPROVED（本番運用） → DEPRECATED（無効化）
```

- APPROVEDのファクターのみがスコアリングで使用されます
- 各ファクターのWeight（重み）を0.1〜5.0で調整可能
- 全ての変更は変更履歴に自動記録されます

### 3.3 ファクター分析

ML手法でファクターの有効性を分析し最適化する3ステップ構成のページです。

| ステップ | 機能 | 目的 |
|----------|------|------|
| Step 1 | 特徴量重要度分析 | どのファクターが有効か診断 |
| Step 2 | Weight最適化 | 過去データから最適な重みを算出 |
| Step 3 | キャリブレーター学習 | スコアを正確な勝率に変換 |

共通パラメータ（開始日・終了日・最大レース数・対象着順）を設定して順番に実行します。

### 3.4 戦略実行

レースを選んでスコアリングし、バリューベットを抽出・投票するページです。

| 表示項目 | 意味 |
|----------|------|
| GY指数 | 馬の総合スコア（100が基準、高いほど有利） |
| 推定勝率 | GY指数から変換した勝利確率 |
| 適正オッズ | 推定勝率の逆数（本来あるべきオッズ） |
| EV | 推定勝率 x 実オッズ（1.0以上で期待値プラス） |

投票方式は `dryrun`（テスト出力のみ）と `ipatgo`（CSV出力）から選択できます。

### 3.5 収支

累計P&L・ROI・回収率・最大DDをKPIカードとチャートで確認するページです。エクイティカーブ（残高推移）とドローダウン推移がグラフ表示されます。

### 3.6 バックテスト

過去データで戦略を検証するページです。日付範囲・初期資金・EV閾値を設定して実行します。実績データ（確定着順+払戻金）に基づく正確なバックテストが可能です。

- **データリーケージ防止**: Weight最適化の訓練期間とバックテスト期間の重複を検出し警告
- **結果一覧**: 過去のバックテスト結果を時系列で比較可能

### 3.7 自動化

パイプライン自動実行の監視・手動実行ページです。

- **実行履歴**: 直近50回のパイプライン結果を一覧表示
- **設定表示**: 現在のconfig.yamlの自動化設定を確認
- **手動実行**: ダッシュボードからは常にdryrunモードが強制されます

### 3.8 AIアシスタント

LLM（Azure OpenAI / Vertex AI）を使った分析機能です。レース分析・ファクター提案・レポート生成が可能です。利用には `config.yaml` と `.env` でのLLM Gateway設定が必要です。

---

## 4. GY指数方式の仕組み

### 4.1 ファクタースコアリングの流れ

```text
1. APPROVEDファクタールールを取得（現在25個）
2. 各馬に対して全ルールを適用
3. ルール適用結果 = raw値 x Weight → weighted_score
4. GY指数 = BASE_SCORE(100) + 全ファクターのweighted_scoreの合算
5. GY指数が高い馬ほど有利と判定
```

例: ある馬が「穴馬DM高評価」（raw=2, weight=2.0）と「前走大敗加点」（raw=1, weight=0.8）に該当した場合、GY指数 = 100 + (2x2.0) + (1x0.8) = **104.8** となります。

### 4.2 Weight最適化の意味

Weightはファクターの「重要度」を数値化したものです。初期値は経験則で設定されていますが、Weight最適化（Step 2）でLogisticRegressionを使い、過去データから統計的に最適なWeightを算出します。

- 的中予測に大きく貢献するファクターは高いWeight（最大3.0）
- 貢献が小さいファクターは低いWeight（最小0.1）
- class_weight="balanced" で的中率の低さ（約5.6%）に対応

### 4.3 キャリブレーション（確率変換）

GY指数（スコア）をそのまま勝率には使えません。キャリブレーションは「GY指数105の馬の勝率は何%か」を過去データから学習するプロセスです。

| 方式 | 特徴 | 推奨場面 |
|------|------|----------|
| **Platt** | シグモイド関数で変換。少ないデータでも安定 | 初期段階（推奨） |
| **Isotonic** | 自由な単調増加関数。データが多ければ高精度 | 10,000頭以上ある場合 |

校正モデルは `data/calibrator.joblib` に保存され、次回スコアリング時に自動読込されます。

### 4.4 EV（期待値）とバリューベット

```text
EV = 推定勝率 x 実オッズ

EV > 1.0  → 理論上プラスの期待値（買い候補）
EV > 1.05 → バリューベット閾値（デフォルト）
EV < 1.0  → 理論上マイナスの期待値（見送り）
```

例: 推定勝率12%、実オッズ10.0倍の馬 → EV = 0.12 x 10.0 = **1.20**（強いバリュー）

閾値を1.05としているのは、誤差のマージンを取るためです。EV=1.01程度では推定精度の範囲内で損失になりうるため、5%のバッファを持たせています。

### 4.5 Quarter Kelly法（資金管理）

Kelly基準は「最適な投資割合」を数学的に求める公式です。

```text
フルKelly: f* = (p x b - q) / b
  p = 推定勝率
  q = 1 - p（推定敗率）
  b = オッズ - 1

Quarter Kelly: 投資額 = 残高 x f* x 0.25
```

フルKellyは理論上最速で資金を増やせますが、推定確率の誤差に対して脆弱です。Quarter Kelly（25%）にすることで、推定誤差があっても壊滅的な損失を回避できます。

**安全機構**:

- レースあたり投票上限: 残高の5%
- 日次投票上限: 残高の20%
- ドローダウン30%超で投票額50%縮小
- 100円単位に丸め（JRA最低投票単位）

---

## 5. ファクター一覧と読み方

### 5.1 カテゴリー説明

| カテゴリー | 説明 | 代表ファクター |
|------------|------|----------------|
| **form** | 前走成績に基づく評価 | 前走上位着順減点、前走大敗加点 |
| **dm** | JRA公式マイニング予想に基づく評価 | DM予想上位、穴馬DM高評価 |
| **gate** | 枠順の有利不利 | 内枠有利(短距離芝)、偶数枠加点 |
| **weight** | 馬体重・斤量に基づく評価 | 大幅増減警戒、軽斤量加点 |
| **gender** | 性別・馬齢に基づく評価 | 牝馬加点(マイル以下)、高齢馬減点 |
| **speed** | 上がり3F（末脚の速さ）に基づく評価 | 上がり3F上位、穴馬末脚 |
| **pace** | 脚質・ペースに基づく評価 | 逃げ先行有利(短距離)、4角好位置 |
| **course** | コース特性（距離×馬場）に基づく評価 | ダート短距離人気薄、芝中距離内枠有利 |
| **odds** | オッズ・市場シグナルに基づく評価 | 中穴ゾーン妙味、過剰人気検出 |
| **combo** | 複合条件（複数要素の組合せ） | 穴馬三重シグナル、DM好走前走敗退 |
| **other** | その他（多頭数・天候など） | 多頭数穴馬、最終レース波乱傾向 |

### 5.2 初期ファクターの考え方

GY指数方式の根幹は**逆張り思想**です。多くのファクターが「市場（オッズ）が織り込んでいない情報を見つける」ことを目的としています。

**逆張り系ファクターの例**:

- 「前走上位着順減点」: 前走好走した馬は過大評価されやすい（人気になりすぎる）ため減点
- 「穴馬DM高評価」: 人気薄だがAI予想は高評価 → 市場が見落としているバリュー
- 「中穴ゾーン妙味」: オッズ10-30倍帯は統計的に回収率が最も高い

**順張り系ファクターの例**:

- 「DM予想上位」: AI予想上位3頭は基本的に能力が高い
- 「上がり3F上位」: 前走で末脚が速かった馬は次走でも好走しやすい

ファクターは「ファクター管理」タブで自由に追加・削除・修正できます。

---

## 6. バックテストの読み方

### 6.1 KPI指標の意味

| 指標 | 計算方法 | 目安 |
|------|----------|------|
| **ROI** | (払戻 - 投票額) / 投票額 | > 0% で黒字。5%以上なら優秀 |
| **回収率** | 払戻 / 投票額 x 100 | > 100% で黒字。JRA平均は約75% |
| **勝率** | 的中数 / 投票数 | 単勝は5-15%が一般的 |
| **シャープレシオ** | 平均リターン / リターンの標準偏差 | > 0.5 で良好、> 1.0 で優秀 |
| **カルマーレシオ** | ROI / 最大DD | > 1.0 でリスク対比の効率が良い |
| **プロフィットファクター** | 総利益 / 総損失 | > 1.0 で黒字、> 1.5 で優秀 |
| **最大DD** | ピーク残高からの最大下落率 | < 20% が理想。30%超は危険水準 |
| **最大連敗** | 連続で外れた最大回数 | 10-20連敗は正常。30以上は要注意 |

### 6.2 データリーケージ警告の意味

バックテスト実行時に「データリーケージ警告」が表示される場合があります。

**データリーケージとは**: Weight最適化に使ったデータ期間とバックテスト期間が重複している状態です。最適化で「答えを知った上で」重みを調整しているため、バックテスト結果が不当に良くなります。

**対策**:

- 「訓練データ重複ファクターを除外する」チェックボックスをONにする
- または、Weight最適化の訓練期間とバックテスト期間を分離する

### 6.3 Walk-Forwardバックテスト

全期間を複数のウィンドウに分割し、各ウィンドウで「訓練→テスト」を順次実行する手法です。

```text
Window 1: [====訓練====][テスト]
Window 2:    [====訓練====][テスト]
Window 3:       [====訓練====][テスト]
```

- 各ウィンドウの訓練ROI vs テストROI を比較
- **過学習度合い**: 訓練ROI / テストROI が2.0以上なら過学習の兆候
- テスト期間の集約ROIが本来の実力に近い数値

### 6.4 モンテカルロシミュレーション

ベット履歴をブートストラップ（復元抽出）してN回のシミュレーションを実行し、確率的な収益分布を推定します。

| 結果項目 | 意味 |
|----------|------|
| PnL平均/中央値 | 長期的な期待収益 |
| PnL 5%/95%タイル | 悲観/楽観シナリオ |
| 最大DD平均/95% | リスクの確率的評価 |
| **破産確率** | 残高がゼロになる確率。1%未満が理想 |

---

## 7. 回収率向上のコツ

### 7.1 Weight最適化の定期実施

月1回程度のWeight再最適化を推奨します。競馬の傾向は季節や年度で変化するため、古いWeightでは市場の変化に追従できません。

```text
推奨サイクル:
  1. 月初に Weight最適化（過去6ヶ月分のデータで学習）
  2. Weight適用後にキャリブレーター再学習
  3. バックテストで最適化前後のROIを比較
  4. 改善が確認できたら本番運用に反映
```

### 7.2 ファクター重要度分析による無効ファクターの除外

全てのファクターが有効とは限りません。定期的に重要度分析（Step 1）を実行し、以下の基準で整理してください。

| 判定 | 基準 | アクション |
|------|------|------------|
| 有効 | PI > 0.01 かつ Lift > 1.5 | 維持 |
| やや有効 | PI > 0 かつ Lift > 1.0 | 維持（改善の余地あり） |
| 要検討 | PI ≒ 0 かつ Lift ≒ 1.0 | 条件の見直しまたは除外 |
| 逆効果 | Lift < 1.0 | **即DEPRECATED推奨** |

無効なファクターがスコアにノイズを加え、全体の精度を下げている可能性があります。

### 7.3 データリーケージを避ける

- バックテスト期間とWeight訓練期間は必ず分離する
- Walk-Forwardバックテストで「未知データでの実力」を確認する
- 確定着順（KakuteiJyuni）やレース当日の上がり3F（last_3f）はファクター式で直接使わない（前走データ `prev_*` を使う）

### 7.4 過学習の兆候と対策

| 兆候 | 説明 | 対策 |
|------|------|------|
| 訓練ROI >> テストROI | Walk-Forwardで訓練期間だけ良い | 正則化を強める（C値を下げる） |
| ファクター数が多すぎる | 25個以上のファクターで過剰適合 | 重要度の低いファクターを除外 |
| 特定期間だけROIが高い | 偶然のパターンに適合 | 複数期間でバックテスト |
| Weight最適化後にROI悪化 | 訓練データに過適合 | 訓練データを増やす（5,000レース以上） |

### 7.5 オッズフィルタリングの活用

config.yamlの `scoring` セクションでオッズ範囲を制限できます。

```yaml
scoring:
  min_odds: 1.5    # 1.5倍未満の馬は除外（ガチガチ本命は期待値が低い）
  max_odds: 100.0  # 100倍以上の馬は除外（推定精度が不安定）
```

統計的に回収率が最も高いのは**オッズ10-30倍帯**（中穴ゾーン）です。ファクター「中穴ゾーン妙味」もこの知見に基づいています。

---

## 8. 税務レポート

### 一時所得の計算方法

競馬の払戻金は税法上「一時所得」として課税されます。

```text
一時所得の計算:
  総収入金額（年間の払戻合計）
  - 控除可能経費（的中した馬券の購入費のみ）
  - 特別控除額（50万円）
  = 一時所得

課税対象額 = 一時所得 x 1/2
```

**重要なポイント**:

- **ハズレ馬券は経費に算入できません**（的中分の購入費のみ控除可能）
- 特別控除50万円以内なら申告不要
- 「収支」タブの税務レポート機能で年間の一時所得・課税対象額を自動計算

### 計算例

| 項目 | 金額 |
|------|------|
| 年間払戻合計 | 2,000,000円 |
| 年間投票合計 | 1,800,000円 |
| うち的中分の購入費 | 300,000円 |
| 総収入金額 | 2,000,000円 |
| 控除可能経費 | 300,000円 |
| 特別控除 | 500,000円 |
| **一時所得** | **1,200,000円** |
| **課税対象額** | **600,000円** |

この場合、600,000円が他の所得と合算されて総合課税されます。確定申告が必要かどうかは税理士にご相談ください。

---

## 9. トラブルシューティング

### よくある問題と解決策

| 問題 | 原因 | 解決策 |
|------|------|--------|
| ダッシュボードが起動しない | .venvが壊れている | `setup.bat` を再実行 |
| JVLink同期が失敗する | exe_pathが不正 | `config.yaml` の `jvlink.exe_path` を確認 |
| スコアリング結果が0件 | APPROVEDファクターがない | ファクター管理でステータスをAPPROVEDに変更 |
| バックテスト対象が0レース | 日付範囲にデータなし | データ管理でレース一覧の日付範囲を確認 |
| Weight最適化で「サンプル不足」 | 的中データが10件未満 | max_racesを増やすか日付範囲を広げる |
| キャリブレーター保存エラー | dataフォルダがない | `data/` フォルダを手動作成 |
| 「校正モデルが未設定」警告 | calibrator.joblibがない | ファクター分析 → Step 3 で学習・保存 |
| EV計算が不正確に見える | キャリブレーター未学習 | 線形変換(score/200)がフォールバック使用中 |
| ポート8501が使用中 | 前回のStreamlitが残存 | `run.bat` が自動でプロセス終了を試みます |
| OneDrive同期でvenvが壊れる | OneDriveが.venv内ファイルをロック | OneDrive同期を一時停止してsetup.bat実行 |

### ログの確認

ログは `logs/` フォルダに保存されます（10MBでローテーション、30日保持）。

```text
# ログレベル
INFO  — 正常動作の記録
WARNING — 注意が必要な状態（フォールバック動作など）
ERROR — エラー発生（処理は継続）
```

---

## 10. 用語集

### 競馬用語

| 用語 | 説明 |
|------|------|
| **単勝** | 1着の馬を当てる馬券。本システムの基本券種 |
| **複勝** | 3着以内の馬を当てる馬券 |
| **オッズ** | 的中時の払戻倍率。オッズ10.0倍 = 100円投票で1,000円払戻 |
| **暗示確率** | 1/オッズ。オッズ10倍 = 暗示確率10% |
| **人気** | 単勝オッズ順位。1番人気 = 最もオッズが低い馬 |
| **上がり3F** | 最後の600mのタイム。末脚の速さの指標 |
| **脚質** | 走り方の傾向（逃げ/先行/差し/追込） |
| **斤量** | 馬が背負う重さ（kg）。ハンデ戦では実力差を調整 |
| **枠順** | ゲート位置。内枠（1-3番）/外枠（14-18番） |
| **馬体重** | 出走前に計量された馬の体重。増減は体調のバロメーター |
| **セン馬** | 去勢された牡馬。気性が安定する傾向 |

### 投資・統計用語

| 用語 | 説明 |
|------|------|
| **EV（期待値）** | Expected Value。推定勝率 x オッズ。1.0以上で理論上プラス |
| **バリューベット** | EV > 閾値（1.05）の投票候補。市場が過小評価している馬への投票 |
| **ROI** | Return on Investment。(払戻-投票額)/投票額 |
| **回収率** | 払戻/投票額 x 100。100%超で黒字 |
| **ドローダウン（DD）** | ピーク残高からの下落率。リスク管理の最重要指標 |
| **シャープレシオ** | リターン/リスク比率。リスク調整済みリターンの指標 |
| **カルマーレシオ** | ROI/最大DD。リスク対比の収益効率 |
| **プロフィットファクター** | 総利益/総損失。1.0超で利益が損失を上回る |
| **Kelly基準** | 最適投資割合の数学的公式。Quarter Kelly = Kelly x 25% |
| **過学習** | 訓練データに適合しすぎて未知データで性能が落ちる現象 |
| **データリーケージ** | 本来使えないはずの未来情報が学習に混入する問題 |

### システム用語

| 用語 | 説明 |
|------|------|
| **GY指数** | 本システム独自の馬評価スコア。BASE_SCORE(100) + 加重ファクター合計 |
| **ファクター** | 馬を評価する個別ルール（例: 前走成績、枠順有利など） |
| **Weight** | ファクターの重み。raw値 x Weight でスコアへの寄与が決まる |
| **キャリブレーション** | GY指数を勝率（確率）に変換する校正処理 |
| **Platt Scaling** | シグモイド関数を使う確率校正手法 |
| **Isotonic Regression** | 単調増加制約付き回帰による確率校正手法 |
| **Brier Score** | 予測確率の二乗平均誤差。0に近いほど良い校正 |
| **PI（Permutation Importance）** | ファクターをシャッフルした時の精度低下量 |
| **Lift** | 発火時的中率/非発火時的中率。1.0以上で有効 |
| **JVLink** | JRA-VANが提供するデータ配信サービス |
| **JVLinkToSQLite** | JVLinkデータをSQLiteに変換する外部ツール |
| **dryrun** | 実際の投票なしでログ出力のみ行うテストモード |
| **ipatgo** | IPAT投票用CSVを出力する投票方式 |
| **Walk-Forward** | 時系列を考慮したバックテスト手法。訓練→テストを順次実行 |
| **モンテカルロ** | ランダムサンプリングで確率分布を推定するシミュレーション手法 |
